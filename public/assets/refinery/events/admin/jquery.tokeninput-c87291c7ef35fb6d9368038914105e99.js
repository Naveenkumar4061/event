/*
 * jQuery Plugin: Tokenizing Autocomplete Text Entry
 * Version 1.6.0
 *
 * Copyright (c) 2009 James Smith (http://loopj.com)
 * Licensed jointly under the GPL and MIT licenses,
 * choose which one suits your project best!
 *
 */
!function(t){var e={method:"GET",contentType:"json",queryParam:"q",searchDelay:300,minChars:1,propertyToSearch:"name",jsonContainer:null,hintText:"Type in a search term",noResultsText:"No results",searchingText:"Searching...",deleteText:"&times;",animateDropdown:!0,tokenLimit:null,tokenDelimiter:",",preventDuplicates:!1,tokenValue:"id",prePopulate:null,processPrePopulate:!1,idPrefix:"token-input-",resultsFormatter:function(t){return"<li>"+t[this.propertyToSearch]+"</li>"},tokenFormatter:function(t){return"<li><p>"+t[this.propertyToSearch]+"</p></li>"},onResult:null,onAdd:null,onDelete:null,onReady:null},i={tokenList:"token-input-list",token:"token-input-token",tokenDelete:"token-input-delete-token",selectedToken:"token-input-selected-token",highlightedToken:"token-input-highlighted-token",dropdown:"token-input-dropdown",dropdownItem:"token-input-dropdown-item",dropdownItem2:"token-input-dropdown-item2",selectedDropdownItem:"token-input-selected-dropdown-item",inputToken:"token-input-input-token"},n={BEFORE:0,AFTER:1,END:2},s={BACKSPACE:8,TAB:9,ENTER:13,ESCAPE:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,NUMPAD_ENTER:108,COMMA:188},o={init:function(i,n){var s=t.extend({},e,n||{});return this.each(function(){t(this).data("tokenInputObject",new t.TokenList(this,i,s))})},clear:function(){return this.data("tokenInputObject").clear(),this},add:function(t){return this.data("tokenInputObject").add(t),this},remove:function(t){return this.data("tokenInputObject").remove(t),this},get:function(){return this.data("tokenInputObject").getTokens()}};t.fn.tokenInput=function(t){return o[t]?o[t].apply(this,Array.prototype.slice.call(arguments,1)):o.init.apply(this,arguments)},t.TokenList=function(e,o,a){function r(){return null!==a.tokenLimit&&A>=a.tokenLimit?(H.hide(),m(),void 0):void 0}function l(){if(E!==(E=H.val())){var t=E.replace(/&/g,"&amp;").replace(/\s/g," ").replace(/</g,"&lt;").replace(/>/g,"&gt;");B.html(t),H.width(B.width()+30)}}function h(e){var i=a.tokenFormatter(e);i=t(i).addClass(a.classes.token).insertBefore(W),t("<span>"+a.deleteText+"</span>").addClass(a.classes.tokenDelete).appendTo(i).click(function(){return f(t(this).parent()),F.change(),!1});var n={id:e.id};return n[a.propertyToSearch]=e[a.propertyToSearch],t.data(i.get(0),"tokeninput",e),M=M.slice(0,z).concat([n]).concat(M.slice(z)),z++,g(M,F),A+=1,null!==a.tokenLimit&&A>=a.tokenLimit&&(H.hide(),m()),i}function c(e){var i=a.onAdd;if(A>0&&a.preventDuplicates){var n=null;if(L.children().each(function(){var i=t(this),s=t.data(i.get(0),"tokeninput");return s&&s.id===e.id?(n=i,!1):void 0}),n)return u(n),W.insertAfter(n),H.focus(),void 0}(null==a.tokenLimit||A<a.tokenLimit)&&(h(e),r()),H.val(""),m(),t.isFunction(i)&&i.call(F,e)}function u(t){t.addClass(a.classes.selectedToken),O=t.get(0),H.val(""),m()}function d(t,e){t.removeClass(a.classes.selectedToken),O=null,e===n.BEFORE?(W.insertBefore(t),z--):e===n.AFTER?(W.insertAfter(t),z++):(W.appendTo(L),z=A),H.focus()}function p(e){var i=O;O&&d(t(O),n.END),i===e.get(0)?d(e,n.END):u(e)}function f(e){var i=t.data(e.get(0),"tokeninput"),n=a.onDelete,s=e.prevAll().length;s>z&&s--,e.remove(),O=null,H.focus(),M=M.slice(0,s).concat(M.slice(s+1)),z>s&&z--,g(M,F),A-=1,null!==a.tokenLimit&&H.show().val("").focus(),t.isFunction(n)&&n.call(F,i)}function g(e,i){var n=t.map(e,function(t){return t[a.tokenValue]});i.val(n.join(a.tokenDelimiter))}function m(){R.hide().empty(),j=null}function v(){R.css({position:"absolute",top:t(L).offset().top+t(L).outerHeight(),left:t(L).offset().left,zindex:999}).show()}function b(){a.searchingText&&(R.html("<p>"+a.searchingText+"</p>"),v())}function _(){a.hintText&&(R.html("<p>"+a.hintText+"</p>"),v())}function y(t,e){return t.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+e+")(?![^<>]*>)(?![^&;]+;)","gi"),"<b>$1</b>")}function w(t,e,i){return t.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+e+")(?![^<>]*>)(?![^&;]+;)","g"),y(e,i))}function x(e,i){if(i&&i.length){R.empty();var n=t("<ul>").appendTo(R).mouseover(function(e){C(t(e.target).closest("li"))}).mousedown(function(e){return c(t(e.target).closest("li").data("tokeninput")),F.change(),!1}).hide();t.each(i,function(i,s){var o=a.resultsFormatter(s);o=w(o,s[a.propertyToSearch],e),o=t(o).appendTo(n),i%2?o.addClass(a.classes.dropdownItem):o.addClass(a.classes.dropdownItem2),0===i&&C(o),t.data(o.get(0),"tokeninput",s)}),v(),a.animateDropdown?n.slideDown("fast"):n.show()}else a.noResultsText&&(R.html("<p>"+a.noResultsText+"</p>"),v())}function C(e){e&&(j&&k(t(j)),e.addClass(a.classes.selectedDropdownItem),j=e.get(0))}function k(t){t.removeClass(a.classes.selectedDropdownItem),j=null}function T(){var e=H.val().toLowerCase();e&&e.length&&(O&&d(t(O),n.AFTER),e.length>=a.minChars?(b(),clearTimeout(P),P=setTimeout(function(){D(e)},a.searchDelay)):m())}function D(e){var i=e+S(),n=N.get(i);if(n)x(e,n);else if(a.url){var s=S(),o={};if(o.data={},s.indexOf("?")>-1){var r=s.split("?");o.url=r[0];var l=r[1].split("&");t.each(l,function(t,e){var i=e.split("=");o.data[i[0]]=i[1]})}else o.url=s;o.data[a.queryParam]=e,o.type=a.method,o.dataType=a.contentType,a.crossDomain&&(o.dataType="jsonp"),o.success=function(n){t.isFunction(a.onResult)&&(n=a.onResult.call(F,n)),N.add(i,a.jsonContainer?n[a.jsonContainer]:n),H.val().toLowerCase()===e&&x(e,a.jsonContainer?n[a.jsonContainer]:n)},t.ajax(o)}else if(a.local_data){var h=t.grep(a.local_data,function(t){return t[a.propertyToSearch].toLowerCase().indexOf(e.toLowerCase())>-1});t.isFunction(a.onResult)&&(h=a.onResult.call(F,h)),N.add(i,h),x(e,h)}}function S(){var t=a.url;return"function"==typeof a.url&&(t=a.url.call()),t}if("string"===t.type(o)||"function"===t.type(o)){a.url=o;var I=S();void 0===a.crossDomain&&(a.crossDomain=-1===I.indexOf("://")?!1:location.href.split(/\/+/g)[1]!==I.split(/\/+/g)[1])}else"object"==typeof o&&(a.local_data=o);a.classes?a.classes=t.extend({},i,a.classes):a.theme?(a.classes={},t.each(i,function(t,e){a.classes[t]=e+"-"+a.theme})):a.classes=i;var P,E,M=[],A=0,N=new t.TokenList.Cache,H=t('<input type="text"  autocomplete="off">').css({outline:"none"}).attr("id",a.idPrefix+e.id).focus(function(){(null===a.tokenLimit||a.tokenLimit!==A)&&_()}).blur(function(){m(),t(this).val("")}).bind("keyup keydown blur update",l).keydown(function(e){var i,o;switch(e.keyCode){case s.LEFT:case s.RIGHT:case s.UP:case s.DOWN:if(t(this).val()){var a=null;return a=e.keyCode===s.DOWN||e.keyCode===s.RIGHT?t(j).next():t(j).prev(),a.length&&C(a),!1}i=W.prev(),o=W.next(),i.length&&i.get(0)===O||o.length&&o.get(0)===O?e.keyCode===s.LEFT||e.keyCode===s.UP?d(t(O),n.BEFORE):d(t(O),n.AFTER):e.keyCode!==s.LEFT&&e.keyCode!==s.UP||!i.length?e.keyCode!==s.RIGHT&&e.keyCode!==s.DOWN||!o.length||u(t(o.get(0))):u(t(i.get(0)));break;case s.BACKSPACE:if(i=W.prev(),!t(this).val().length)return O?(f(t(O)),F.change()):i.length&&u(t(i.get(0))),!1;1===t(this).val().length?m():setTimeout(function(){T()},5);break;case s.TAB:case s.ENTER:case s.NUMPAD_ENTER:case s.COMMA:if(j)return c(t(j).data("tokeninput")),F.change(),!1;break;case s.ESCAPE:return m(),!0;default:String.fromCharCode(e.which)&&setTimeout(function(){T()},5)}}),F=t(e).hide().val("").focus(function(){H.focus()}).blur(function(){H.blur()}),O=null,z=0,j=null,L=t("<ul />").addClass(a.classes.tokenList).click(function(e){var i=t(e.target).closest("li");i&&i.get(0)&&t.data(i.get(0),"tokeninput")?p(i):(O&&d(t(O),n.END),H.focus())}).mouseover(function(e){var i=t(e.target).closest("li");i&&O!==this&&i.addClass(a.classes.highlightedToken)}).mouseout(function(e){var i=t(e.target).closest("li");i&&O!==this&&i.removeClass(a.classes.highlightedToken)}).insertBefore(F),W=t("<li />").addClass(a.classes.inputToken).appendTo(L).append(H),R=t("<div>").addClass(a.classes.dropdown).appendTo("body").hide(),B=t("<tester/>").insertAfter(H).css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:H.css("fontSize"),fontFamily:H.css("fontFamily"),fontWeight:H.css("fontWeight"),letterSpacing:H.css("letterSpacing"),whiteSpace:"nowrap"});F.val("");var $=a.prePopulate||F.data("pre");a.processPrePopulate&&t.isFunction(a.onResult)&&($=a.onResult.call(F,$)),$&&$.length&&t.each($,function(t,e){h(e),r()}),t.isFunction(a.onReady)&&a.onReady.call(),this.clear=function(){L.children("li").each(function(){0===t(this).children("input").length&&f(t(this))})},this.add=function(t){c(t)},this.remove=function(e){L.children("li").each(function(){if(0===t(this).children("input").length){var i=t(this).data("tokeninput"),n=!0;for(var s in e)if(e[s]!==i[s]){n=!1;break}n&&f(t(this))}})},this.getTokens=function(){return M}},t.TokenList.Cache=function(e){var i=t.extend({max_size:500},e),n={},s=0,o=function(){n={},s=0};this.add=function(t,e){s>i.max_size&&o(),n[t]||(s+=1),n[t]=e},this.get=function(t){return n[t]}}}(jQuery);