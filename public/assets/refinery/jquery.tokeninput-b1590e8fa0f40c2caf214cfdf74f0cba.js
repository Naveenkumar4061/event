/*
 * jQuery Plugin: Tokenizing Autocomplete Text Entry
 * Version 1.6.0
 *
 * Copyright (c) 2009 James Smith (http://loopj.com)
 * Licensed jointly under the GPL and MIT licenses,
 * choose which one suits your project best!
 *
 */
!function(t){var e={method:"GET",contentType:"json",queryParam:"q",searchDelay:300,minChars:1,propertyToSearch:"name",jsonContainer:null,hintText:"Type in a search term",noResultsText:"No results",searchingText:"Searching...",deleteText:"&times;",animateDropdown:!0,tokenLimit:null,tokenDelimiter:",",preventDuplicates:!1,tokenValue:"id",prePopulate:null,processPrePopulate:!1,idPrefix:"token-input-",resultsFormatter:function(t){return"<li>"+t[this.propertyToSearch]+"</li>"},tokenFormatter:function(t){return"<li><p>"+t[this.propertyToSearch]+"</p></li>"},onResult:null,onAdd:null,onDelete:null,onReady:null},i={tokenList:"token-input-list",token:"token-input-token",tokenDelete:"token-input-delete-token",selectedToken:"token-input-selected-token",highlightedToken:"token-input-highlighted-token",dropdown:"token-input-dropdown",dropdownItem:"token-input-dropdown-item",dropdownItem2:"token-input-dropdown-item2",selectedDropdownItem:"token-input-selected-dropdown-item",inputToken:"token-input-input-token"},n={BEFORE:0,AFTER:1,END:2},s={BACKSPACE:8,TAB:9,ENTER:13,ESCAPE:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,NUMPAD_ENTER:108,COMMA:188},a={init:function(i,n){var s=t.extend({},e,n||{});return this.each(function(){t(this).data("tokenInputObject",new t.TokenList(this,i,s))})},clear:function(){return this.data("tokenInputObject").clear(),this},add:function(t){return this.data("tokenInputObject").add(t),this},remove:function(t){return this.data("tokenInputObject").remove(t),this},get:function(){return this.data("tokenInputObject").getTokens()}};t.fn.tokenInput=function(t){return a[t]?a[t].apply(this,Array.prototype.slice.call(arguments,1)):a.init.apply(this,arguments)},t.TokenList=function(e,a,o){function r(){return null!==o.tokenLimit&&N>=o.tokenLimit?(F.hide(),m(),void 0):void 0}function l(){if(E!==(E=F.val())){var t=E.replace(/&/g,"&amp;").replace(/\s/g," ").replace(/</g,"&lt;").replace(/>/g,"&gt;");B.html(t),F.width(B.width()+30)}}function h(e){var i=o.tokenFormatter(e);i=t(i).addClass(o.classes.token).insertBefore(z),t("<span>"+o.deleteText+"</span>").addClass(o.classes.tokenDelete).appendTo(i).click(function(){return f(t(this).parent()),H.change(),!1});var n={id:e.id};return n[o.propertyToSearch]=e[o.propertyToSearch],t.data(i.get(0),"tokeninput",e),A=A.slice(0,L).concat([n]).concat(A.slice(L)),L++,g(A,H),N+=1,null!==o.tokenLimit&&N>=o.tokenLimit&&(F.hide(),m()),i}function u(e){var i=o.onAdd;if(N>0&&o.preventDuplicates){var n=null;if(R.children().each(function(){var i=t(this),s=t.data(i.get(0),"tokeninput");return s&&s.id===e.id?(n=i,!1):void 0}),n)return c(n),z.insertAfter(n),F.focus(),void 0}(null==o.tokenLimit||N<o.tokenLimit)&&(h(e),r()),F.val(""),m(),t.isFunction(i)&&i.call(H,e)}function c(t){t.addClass(o.classes.selectedToken),j=t.get(0),F.val(""),m()}function d(t,e){t.removeClass(o.classes.selectedToken),j=null,e===n.BEFORE?(z.insertBefore(t),L--):e===n.AFTER?(z.insertAfter(t),L++):(z.appendTo(R),L=N),F.focus()}function p(e){var i=j;j&&d(t(j),n.END),i===e.get(0)?d(e,n.END):c(e)}function f(e){var i=t.data(e.get(0),"tokeninput"),n=o.onDelete,s=e.prevAll().length;s>L&&s--,e.remove(),j=null,F.focus(),A=A.slice(0,s).concat(A.slice(s+1)),L>s&&L--,g(A,H),N-=1,null!==o.tokenLimit&&F.show().val("").focus(),t.isFunction(n)&&n.call(H,i)}function g(e,i){var n=t.map(e,function(t){return t[o.tokenValue]});i.val(n.join(o.tokenDelimiter))}function m(){W.hide().empty(),O=null}function v(){W.css({position:"absolute",top:t(R).offset().top+t(R).outerHeight(),left:t(R).offset().left,zindex:999}).show()}function b(){o.searchingText&&(W.html("<p>"+o.searchingText+"</p>"),v())}function y(){o.hintText&&(W.html("<p>"+o.hintText+"</p>"),v())}function _(t,e){return t.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+e+")(?![^<>]*>)(?![^&;]+;)","gi"),"<b>$1</b>")}function C(t,e,i){return t.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+e+")(?![^<>]*>)(?![^&;]+;)","g"),_(e,i))}function w(e,i){if(i&&i.length){W.empty();var n=t("<ul>").appendTo(W).mouseover(function(e){x(t(e.target).closest("li"))}).mousedown(function(e){return u(t(e.target).closest("li").data("tokeninput")),H.change(),!1}).hide();t.each(i,function(i,s){var a=o.resultsFormatter(s);a=C(a,s[o.propertyToSearch],e),a=t(a).appendTo(n),i%2?a.addClass(o.classes.dropdownItem):a.addClass(o.classes.dropdownItem2),0===i&&x(a),t.data(a.get(0),"tokeninput",s)}),v(),o.animateDropdown?n.slideDown("fast"):n.show()}else o.noResultsText&&(W.html("<p>"+o.noResultsText+"</p>"),v())}function x(e){e&&(O&&S(t(O)),e.addClass(o.classes.selectedDropdownItem),O=e.get(0))}function S(t){t.removeClass(o.classes.selectedDropdownItem),O=null}function D(){var e=F.val().toLowerCase();e&&e.length&&(j&&d(t(j),n.AFTER),e.length>=o.minChars?(b(),clearTimeout(P),P=setTimeout(function(){T(e)},o.searchDelay)):m())}function T(e){var i=e+k(),n=M.get(i);if(n)w(e,n);else if(o.url){var s=k(),a={};if(a.data={},s.indexOf("?")>-1){var r=s.split("?");a.url=r[0];var l=r[1].split("&");t.each(l,function(t,e){var i=e.split("=");a.data[i[0]]=i[1]})}else a.url=s;a.data[o.queryParam]=e,a.type=o.method,a.dataType=o.contentType,o.crossDomain&&(a.dataType="jsonp"),a.success=function(n){t.isFunction(o.onResult)&&(n=o.onResult.call(H,n)),M.add(i,o.jsonContainer?n[o.jsonContainer]:n),F.val().toLowerCase()===e&&w(e,o.jsonContainer?n[o.jsonContainer]:n)},t.ajax(a)}else if(o.local_data){var h=t.grep(o.local_data,function(t){return t[o.propertyToSearch].toLowerCase().indexOf(e.toLowerCase())>-1});t.isFunction(o.onResult)&&(h=o.onResult.call(H,h)),M.add(i,h),w(e,h)}}function k(){var t=o.url;return"function"==typeof o.url&&(t=o.url.call()),t}if("string"===t.type(a)||"function"===t.type(a)){o.url=a;var I=k();void 0===o.crossDomain&&(o.crossDomain=-1===I.indexOf("://")?!1:location.href.split(/\/+/g)[1]!==I.split(/\/+/g)[1])}else"object"==typeof a&&(o.local_data=a);o.classes?o.classes=t.extend({},i,o.classes):o.theme?(o.classes={},t.each(i,function(t,e){o.classes[t]=e+"-"+o.theme})):o.classes=i;var P,E,A=[],N=0,M=new t.TokenList.Cache,F=t('<input type="text"  autocomplete="off">').css({outline:"none"}).attr("id",o.idPrefix+e.id).focus(function(){(null===o.tokenLimit||o.tokenLimit!==N)&&y()}).blur(function(){m(),t(this).val("")}).bind("keyup keydown blur update",l).keydown(function(e){var i,a;switch(e.keyCode){case s.LEFT:case s.RIGHT:case s.UP:case s.DOWN:if(t(this).val()){var o=null;return o=e.keyCode===s.DOWN||e.keyCode===s.RIGHT?t(O).next():t(O).prev(),o.length&&x(o),!1}i=z.prev(),a=z.next(),i.length&&i.get(0)===j||a.length&&a.get(0)===j?e.keyCode===s.LEFT||e.keyCode===s.UP?d(t(j),n.BEFORE):d(t(j),n.AFTER):e.keyCode!==s.LEFT&&e.keyCode!==s.UP||!i.length?e.keyCode!==s.RIGHT&&e.keyCode!==s.DOWN||!a.length||c(t(a.get(0))):c(t(i.get(0)));break;case s.BACKSPACE:if(i=z.prev(),!t(this).val().length)return j?(f(t(j)),H.change()):i.length&&c(t(i.get(0))),!1;1===t(this).val().length?m():setTimeout(function(){D()},5);break;case s.TAB:case s.ENTER:case s.NUMPAD_ENTER:case s.COMMA:if(O)return u(t(O).data("tokeninput")),H.change(),!1;break;case s.ESCAPE:return m(),!0;default:String.fromCharCode(e.which)&&setTimeout(function(){D()},5)}}),H=t(e).hide().val("").focus(function(){F.focus()}).blur(function(){F.blur()}),j=null,L=0,O=null,R=t("<ul />").addClass(o.classes.tokenList).click(function(e){var i=t(e.target).closest("li");i&&i.get(0)&&t.data(i.get(0),"tokeninput")?p(i):(j&&d(t(j),n.END),F.focus())}).mouseover(function(e){var i=t(e.target).closest("li");i&&j!==this&&i.addClass(o.classes.highlightedToken)}).mouseout(function(e){var i=t(e.target).closest("li");i&&j!==this&&i.removeClass(o.classes.highlightedToken)}).insertBefore(H),z=t("<li />").addClass(o.classes.inputToken).appendTo(R).append(F),W=t("<div>").addClass(o.classes.dropdown).appendTo("body").hide(),B=t("<tester/>").insertAfter(F).css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:F.css("fontSize"),fontFamily:F.css("fontFamily"),fontWeight:F.css("fontWeight"),letterSpacing:F.css("letterSpacing"),whiteSpace:"nowrap"});H.val("");var q=o.prePopulate||H.data("pre");o.processPrePopulate&&t.isFunction(o.onResult)&&(q=o.onResult.call(H,q)),q&&q.length&&t.each(q,function(t,e){h(e),r()}),t.isFunction(o.onReady)&&o.onReady.call(),this.clear=function(){R.children("li").each(function(){0===t(this).children("input").length&&f(t(this))})},this.add=function(t){u(t)},this.remove=function(e){R.children("li").each(function(){if(0===t(this).children("input").length){var i=t(this).data("tokeninput"),n=!0;for(var s in e)if(e[s]!==i[s]){n=!1;break}n&&f(t(this))}})},this.getTokens=function(){return A}},t.TokenList.Cache=function(e){var i=t.extend({max_size:500},e),n={},s=0,a=function(){n={},s=0};this.add=function(t,e){s>i.max_size&&a(),n[t]||(s+=1),n[t]=e},this.get=function(t){return n[t]}}}(jQuery);